name: Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v0.1, v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build:
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile --name oops --icon oops.ico oops.py
    
    - name: Prepare release package
      run: |
        mkdir release-package
        mv dist/oops.exe release-package/oops-windows-x64.exe
        cp -r configs release-package/
    
    - name: Create ZIP archive
      run: |
        Compress-Archive -Path release-package/* -DestinationPath oops-windows-x64.zip
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: oops-windows
        path: oops-windows-x64.zip
        retention-days: 7

  release:
    name: Create Release
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: oops-windows
        path: .
    
    - name: Display structure
      run: dir
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: OOPS ${{ github.ref_name }}
        body: |
          ## OOPS - One-click Operating Pre-check System
          
          è®©æ¸¸æˆè„šæœ¬è¿è¡Œæ›´é¡ºç•… | Run Your Game Scripts Smoothly
          
          ### ğŸ“¦ ä¸‹è½½
          
          ä¸‹è½½ `oops-windows-x64.zip`ï¼Œè§£å‹ååŒå‡»è¿è¡Œ `oops-windows-x64.exe`
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          
          1. è§£å‹ `oops-windows-x64.zip`
          2. åŒå‡»è¿è¡Œ `oops-windows-x64.exe`
          3. é€‰æ‹©è¦æ£€æµ‹çš„æ¸¸æˆè„šæœ¬é¡¹ç›®
          4. ç­‰å¾…æ£€æµ‹å®Œæˆ
          5. æŸ¥çœ‹è‡ªåŠ¨æ‰“å¼€çš„HTMLæŠ¥å‘Š
          
          **æ³¨æ„**: configs æ–‡ä»¶å¤¹åŒ…å«äº†é¢„é…ç½®çš„æ¸¸æˆæ£€æµ‹è§„åˆ™ï¼Œè¯·ä¿æŒåœ¨åŒä¸€ç›®å½•ä¸‹
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          
          - ç³»ç»Ÿä¿¡æ¯æ£€æµ‹ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ã€GPUã€æ˜¾ç¤ºè®¾ç½®ï¼‰
          - ç¡¬ä»¶é€‚é…æ£€æµ‹ï¼ˆå†…å­˜ã€ç£ç›˜ç±»å‹ã€åˆ†è¾¨ç‡éªŒè¯ï¼‰
          - ç½‘ç»œè¿é€šæ€§æ£€æµ‹ï¼ˆGitä»“åº“ã€PyPIæºï¼‰
          - ç¯å¢ƒä¾èµ–æ£€æµ‹ï¼ˆPythonç‰ˆæœ¬ã€ç³»ç»Ÿåº“ï¼‰
          - è·¯å¾„è§„èŒƒæ£€æµ‹ï¼ˆä¸­æ–‡è·¯å¾„ã€ç‰¹æ®Šå­—ç¬¦ï¼‰
          
          ### ğŸ“š æ–‡æ¡£
          
          - [å¿«é€Ÿå¼€å§‹](https://github.com/${{ github.repository }}/blob/main/QUICKSTART.md)
          - [ç”¨æˆ·æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/USER_GUIDE.md)
          - [æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
        files: |
          oops-windows-x64.zip
        draft: false
        prerelease: false
