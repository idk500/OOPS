name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build:
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile --name oops --icon oops.ico oops.py
    
    - name: Rename artifact
      run: |
        mv dist/oops.exe dist/oops-windows-x64.exe
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: oops-windows
        path: dist/oops-windows-x64.exe
        retention-days: 7

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: oops-windows
        path: artifacts
    
    - name: Display structure
      run: ls -R artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: OOPS ${{ github.ref_name }}
        body: |
          ## OOPS - One-click Operating Pre-check System
          
          è®©æ¸¸æˆè„šæœ¬è¿è¡Œæ›´é¡ºç•… | Run Your Game Scripts Smoothly
          
          ### ğŸ“¦ ä¸‹è½½
          
          ä¸‹è½½ `oops-windows-x64.exe` å¹¶åŒå‡»è¿è¡Œ
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          
          1. åŒå‡»è¿è¡Œ `oops-windows-x64.exe`
          2. é€‰æ‹©è¦æ£€æµ‹çš„æ¸¸æˆè„šæœ¬é¡¹ç›®
          3. ç­‰å¾…æ£€æµ‹å®Œæˆ
          4. æŸ¥çœ‹è‡ªåŠ¨æ‰“å¼€çš„HTMLæŠ¥å‘Š
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          
          - ç³»ç»Ÿä¿¡æ¯æ£€æµ‹ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ã€GPUã€æ˜¾ç¤ºè®¾ç½®ï¼‰
          - ç¡¬ä»¶é€‚é…æ£€æµ‹ï¼ˆå†…å­˜ã€ç£ç›˜ç±»å‹ã€åˆ†è¾¨ç‡éªŒè¯ï¼‰
          - ç½‘ç»œè¿é€šæ€§æ£€æµ‹ï¼ˆGitä»“åº“ã€PyPIæºï¼‰
          - ç¯å¢ƒä¾èµ–æ£€æµ‹ï¼ˆPythonç‰ˆæœ¬ã€ç³»ç»Ÿåº“ï¼‰
          - è·¯å¾„è§„èŒƒæ£€æµ‹ï¼ˆä¸­æ–‡è·¯å¾„ã€ç‰¹æ®Šå­—ç¬¦ï¼‰
          
          ### ğŸ“š æ–‡æ¡£
          
          - [å¿«é€Ÿå¼€å§‹](https://github.com/${{ github.repository }}/blob/main/QUICKSTART.md)
          - [ç”¨æˆ·æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/USER_GUIDE.md)
          - [æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
        files: |
          artifacts/oops-windows-x64.exe
        draft: false
        prerelease: false
