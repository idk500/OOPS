name: Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæŽ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v0.1, v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build:
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile --name oops --icon oops.ico oops.py
    
    - name: Extract version from tag
      id: get_version
      run: |
        $version = "${{ github.ref_name }}"
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: Prepare release package
      run: |
        mkdir release-package
        mv dist/oops.exe release-package/oops-windows-x64.exe
        cp -r configs release-package/
        cp README.md release-package/
        cp QUICKSTART.md release-package/
        cp CHANGELOG.md release-package/
    
    - name: Create ZIP archive with version
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $zipName = "oops-windows-x64_$version.zip"
        Compress-Archive -Path release-package/* -DestinationPath $zipName
        echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: oops-windows
        path: ${{ env.ZIP_NAME }}
        retention-days: 7

  release:
    name: Create Release
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: oops-windows
        path: .
    
    - name: Display structure
      run: dir
    
    - name: Extract version from tag
      id: get_version
      run: |
        $version = "${{ github.ref_name }}" -replace '^v', ''
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: Extract changelog for this version
      id: changelog
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $content = Get-Content CHANGELOG.md -Raw -Encoding UTF8
        
        # æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹
        $pattern = "(?s)## v$version.*?(?=\n## v|\z)"
        if ($content -match $pattern) {
          $versionChangelog = $matches[0]
          # ç§»é™¤ç‰ˆæœ¬æ ‡é¢˜è¡Œ
          $versionChangelog = $versionChangelog -replace "^## v$version[^\n]*\n", ""
          $versionChangelog = $versionChangelog.Trim()
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          $versionChangelog | Out-File -FilePath version-changelog.md -Encoding utf8
          echo "âœ… Found changelog for version $version"
        } else {
          echo "âš ï¸ No changelog found for version $version, using default"
          @"
        ### æ›´æ–°å†…å®¹
        
        è¯·æŸ¥çœ‹ [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
        "@ | Out-File -FilePath version-changelog.md -Encoding utf8
        }
    
    - name: Create release notes file
      run: |
        @"
        ## OOPS - One-click Operating Pre-check System

        è®©æ¸¸æˆè„šæœ¬è¿è¡Œæ›´é¡ºç•… | Run Your Game Scripts Smoothly

        ### ðŸ“¦ ä¸‹è½½

        ä¸‹è½½ ``oops-windows-x64.zip``ï¼Œè§£åŽ‹åŽåŒå‡»è¿è¡Œ ``oops-windows-x64.exe``

        ### ðŸš€ ä½¿ç”¨æ–¹æ³•

        1. è§£åŽ‹ ``oops-windows-x64.zip``
        2. åŒå‡»è¿è¡Œ ``oops-windows-x64.exe``
        3. è‡ªåŠ¨æ£€æµ‹æ‰€æœ‰å¯ç”¨é¡¹ç›®å¹¶ç”ŸæˆæŠ¥å‘Š
        4. æŸ¥çœ‹è‡ªåŠ¨æ‰“å¼€çš„HTMLæŠ¥å‘Š

        **æ³¨æ„**: configs æ–‡ä»¶å¤¹åŒ…å«äº†é¢„é…ç½®çš„æ¸¸æˆæ£€æµ‹è§„åˆ™ï¼Œè¯·ä¿æŒåœ¨åŒä¸€ç›®å½•ä¸‹

        ---

        "@ | Out-File -FilePath release-notes.md -Encoding utf8
        
        # è¿½åŠ ç‰ˆæœ¬æ›´æ–°å†…å®¹
        Get-Content version-changelog.md -Raw -Encoding UTF8 | Add-Content -Path release-notes.md -Encoding utf8
        
        # è¿½åŠ æ–‡æ¡£é“¾æŽ¥
        @"

        ---

        ### ðŸ“š æ–‡æ¡£

        - [å¿«é€Ÿå¼€å§‹](https://github.com/${{ github.repository }}/blob/main/QUICKSTART.md)
        - [ç”¨æˆ·æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/USER_GUIDE.md)
        - [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
        "@ | Add-Content -Path release-notes.md -Encoding utf8
        
        echo "=== Release Notes Preview ==="
        Get-Content release-notes.md -Encoding UTF8
        echo "==========================="
    
    - name: Get ZIP filename
      run: |
        $zipFile = Get-ChildItem -Filter "oops-windows-x64_*.zip" | Select-Object -First 1 -ExpandProperty Name
        echo "ZIP_FILE=$zipFile" >> $env:GITHUB_ENV
        echo "Found ZIP file: $zipFile"
    
    - name: Create Release with GitHub CLI
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create ${{ github.ref_name }} `
          ${{ env.ZIP_FILE }} `
          --title "OOPS ${{ github.ref_name }}" `
          --notes-file release-notes.md `
          --verify-tag
